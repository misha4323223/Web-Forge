# Деплой на Яндекс Cloud: Object Storage + Cloud Functions

Самый дешёвый вариант (~₽50-200/месяц)

---

## Часть 1: Подготовка файлов

### Шаг 1: Скачай проект из Replit
1. В Replit нажми на три точки (⋮) рядом с названием проекта
2. Выбери **"Download as zip"**
3. Сохрани и распакуй архив на компьютер

---

## Часть 2: Создание Cloud Function (для форм + PDF договора)

> **ВАЖНО:** Функция использует шрифты Roboto для генерации PDF с кириллицей. 
> Шрифты — это бинарные файлы, их **НЕЛЬЗЯ** скопировать в редактор кода!
> Нужно загрузить функцию как **ZIP-архив**.

### Шаг 1: Создай ZIP-архив с функцией

**На Windows:**
1. Открой папку `yandex-cloud-function` в распакованном проекте
2. Выдели ВСЕ 4 файла:
   - `index.js`
   - `package.json`
   - `Roboto-Regular.ttf`
   - `Roboto-Bold.ttf`
3. Нажми правой кнопкой мыши → **"Отправить"** → **"Сжатая ZIP-папка"**
4. Назови архив `function.zip`

**На Mac/Linux:**
```bash
cd путь/к/проекту/yandex-cloud-function
zip function.zip index.js package.json Roboto-Regular.ttf Roboto-Bold.ttf
```

### Шаг 2: Открой консоль Яндекс Cloud
1. Зайди на [console.cloud.yandex.ru](https://console.cloud.yandex.ru)
2. Войди в свой аккаунт

### Шаг 3: Перейди в Cloud Functions
1. В левом меню найди **"Cloud Functions"**
2. Нажми на него

### Шаг 4: Создай функцию
1. Нажми **"Создать функцию"**
2. Заполни:
   - **Имя:** `webstudio-api`
   - Нажми **"Создать"**

### Шаг 5: Загрузи ZIP-архив
1. После создания откроется страница функции
2. Нажми **"Редактор"** (или "Создать версию")
3. **ВАЖНО!** В разделе "Способ" выбери: **"ZIP-архив"**
4. Нажми **"Загрузить файл"** и выбери `function.zip`
5. Заполни настройки:
   - **Среда выполнения:** `nodejs22`
   - **Точка входа:** `index.handler`
   - **Таймаут:** `30 секунд` (нужно время для генерации PDF)
   - **Память:** `256 МБ` (нужно для PDF)

### Шаг 6: Добавь переменные окружения
**Обязательные для оплаты:**
- `ROBOKASSA_MERCHANT_LOGIN` — логин магазина в Robokassa
- `ROBOKASSA_PASSWORD1` — пароль #1 для подписи
- `ROBOKASSA_PASSWORD2` — пароль #2 для проверки
- `ROBOKASSA_TEST_MODE` — `true` для теста, `false` для боевого режима
- `SITE_URL` — URL твоего сайта (например: `https://www.mp-webstudio.ru`)

**Для отправки договора на email:**
- `SMTP_EMAIL` — email на Яндекс.Почте (например: `noreply@mp-webstudio.ru`)
- `SMTP_PASSWORD` — пароль приложения (создаётся на id.yandex.ru → Пароли приложений)

**Для уведомлений в Telegram:**
- `TELEGRAM_BOT_TOKEN` — токен бота (получить у @BotFather)
- `TELEGRAM_CHAT_ID` — ID чата для уведомлений

### Шаг 7: Сохрани функцию
1. Нажми **"Создать версию"**
2. Дождись создания (1-2 минуты)
3. Если ошибка — проверь, что в ZIP есть все 4 файла!

### Шаг 8: Сделай функцию публичной
1. Перейди на вкладку **"Обзор"**
2. Найди раздел **"Общий доступ"**
3. Включи **"Публичная функция"**

### Шаг 9: Скопируй URL функции
1. На странице функции найди **"Ссылка для вызова"**
2. Скопируй URL (выглядит как: `https://functions.yandexcloud.net/xxxxx`)
3. **Сохрани этот URL** — он понадобится дальше!

---

## Часть 3: Сборка фронтенда

### Шаг 1: Создай файл с переменной окружения
1. В распакованной папке создай файл `.env.production`
2. Добавь в него строку (замени URL на свой из Шага 9):
```
VITE_API_URL=https://functions.yandexcloud.net/xxxxx
```

### Шаг 2: Установи зависимости и собери проект
1. Открой терминал (cmd или PowerShell)
2. Перейди в папку проекта:
```
cd путь\к\папке\проекта
```
3. Установи зависимости:
```
npm install
```
4. Собери фронтенд:
```
npm run build
```
5. После сборки появится папка `dist/public` — это твой готовый сайт!

---

## Часть 4: Создание Object Storage (для файлов сайта)

### Шаг 1: Перейди в Object Storage
1. В левом меню консоли найди **"Object Storage"**
2. Нажми на него

### Шаг 2: Создай бакет
1. Нажми **"Создать бакет"**
2. Заполни:
   - **Имя бакета:** `webstudio-site` (или любое уникальное имя)
   - **Макс. размер:** оставь пустым
   - **Доступ на чтение объектов:** **Публичный**
   - **Доступ к списку объектов:** Ограниченный
   - **Класс хранилища:** Стандартное
3. Нажми **"Создать бакет"**

### Шаг 3: Настрой хостинг сайта
1. Открой созданный бакет
2. Перейди на вкладку **"Веб-сайт"**
3. Нажми **"Настроить"**
4. Заполни:
   - **Хостинг:** включи
   - **Главная страница:** `index.html`
   - **Страница ошибки:** `index.html` (для SPA)
5. Нажми **"Сохранить"**
6. **Скопируй URL сайта** (появится после сохранения)

### Шаг 4: Загрузи файлы сайта
1. Перейди на вкладку **"Объекты"**
2. Нажми **"Загрузить"**
3. Загрузи ВСЕ файлы из папки `dist/public`:
   - `index.html`
   - Папку `assets` (со всеми файлами внутри)

**Важно:** При загрузке папки `assets` нужно сохранить структуру. 
Либо загружай файлы по одному, указывая путь `assets/имя-файла`.

### Альтернативный способ загрузки (если много файлов):
Используй **Яндекс S3 CLI** или **Rclone** для массовой загрузки.

---

## Часть 5: Проверка

### Шаг 1: Открой сайт
1. Перейди по URL бакета (из Части 4, Шаг 3)
2. Сайт должен открыться!

### Шаг 2: Проверь форму
1. Заполни форму на сайте
2. Нажми "Отправить"
3. Должно появиться сообщение об успехе
4. Если настроен Telegram — придёт уведомление

---

## Часть 6: Привязка домена (опционально)

### Шаг 1: Добавь домен в Яндекс Cloud
1. Перейди в **"Certificate Manager"**
2. Создай SSL-сертификат для твоего домена

### Шаг 2: Настрой DNS
1. У регистратора домена добавь CNAME запись:
   - **Имя:** `www` (или `@`)
   - **Значение:** URL твоего бакета

---

## Полезные команды

### Обновление сайта:
1. Скачай новую версию из Replit
2. Пересобери: `npm run build`
3. Загрузи новые файлы в бакет (можно перезаписать старые)

### Обновление функции:
1. Открой функцию в консоли
2. Нажми "Редактор"
3. Вставь новый код
4. Нажми "Создать версию"

---

## Стоимость

| Сервис | Бесплатный лимит | Примерная цена |
|--------|------------------|----------------|
| Object Storage | 10 ГБ трафика | ~₽50/мес |
| Cloud Functions | 1 млн вызовов | Бесплатно |
| **Итого** | | **~₽50-100/мес** |

---

## Возможные проблемы

### Форма не отправляется
- Проверь, что функция публичная
- Проверь URL в `.env.production`
- Пересобери проект после изменения `.env.production`

### Сайт не открывается
- Проверь, что бакет публичный
- Проверь, что включён хостинг
- Убедись, что загружен `index.html`

### CORS ошибка
- В функции уже настроены правильные заголовки
- Если ошибка осталась — проверь URL функции

---

*Вопросы? Пиши в чат — разберёмся!*
